image: docker:24.0.6-cli
options:
  docker: true

definitions:
  steps:
    - step: &build-push
        name: Build & Push (frontend)
        services: [docker]
        script:
          - apk add --no-cache aws-cli jq bash
          - set -euo pipefail

          # branch → deploy env
          - |
            if [ "$BITBUCKET_BRANCH" = "main" ]; then
              DEPLOY_ENV="prod"
            elif [ "$BITBUCKET_BRANCH" = "staging" ]; then
              DEPLOY_ENV="staging"
            else
              echo "❌ Unsupported branch $BITBUCKET_BRANCH"; exit 1
            fi
            echo "$DEPLOY_ENV" > .deploy_env

          # required
          - '[ -n "${AWS_REGION}" ] || { echo "AWS_REGION is required"; exit 1; }'
          - '[ -n "${PROJECT}" ]    || { echo "PROJECT is required"; exit 1; }'

          # image + repo
          - export DOCKER_DEFAULT_PLATFORM=linux/amd64
          - REPO_NAME="${PROJECT}-${DEPLOY_ENV}-backend"
          - VERSION=$(cat VERSION)
          - AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          - IMAGE_URI="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${REPO_NAME}:${VERSION}"

          # ECR login + build (no BuildKit) + push
          - aws ecr get-login-password --region "${AWS_REGION}" | docker login --username AWS --password-stdin "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
          - export DOCKER_BUILDKIT=0
          - export COMPOSE_DOCKER_CLI_BUILD=0
          - export IMAGE_URI
          - docker compose -f docker-compose.build.yml build
          - docker push "${IMAGE_URI}"

          # hand off to deploy
          - echo "${VERSION}" > .version
        artifacts:
          - .deploy_env
          - .version

    - step: &deploy
        # Use a Node image so we have node+npm for CDK
        image: node:20-alpine
        name: Deploy (update FrontendImageTag)
        script:
          - apk add --no-cache aws-cli bash jq
          - set -euo pipefail

          - DEPLOY_ENV=$(cat .deploy_env)
          - VERSION=$(cat .version)

          - '[ -n "${AWS_REGION}" ] || { echo "AWS_REGION is required"; exit 1; }'
          - '[ -n "${PROJECT}" ]    || { echo "PROJECT is required"; exit 1; }'

          - STACK_NAME="${PROJECT}-backend-${DEPLOY_ENV}"
          - echo "🛠 Deploying to stack ${STACK_NAME} (env ${DEPLOY_ENV}) with version ${VERSION}"

          # ensure infra deps are installed
          - cd infra
          - npm ci              # installs aws-cdk CLI if listed as devDependency
          - npx cdk --version   # sanity
          # optional: refresh context if you rely on lookups
          - npx cdk context --clear || true
          - npx cdk deploy \
              --require-approval never \
              --context version="${VERSION}"

pipelines:
  branches:
    main:
      - step:
          <<: *build-push
          deployment: prod    # only here
      - step:
          <<: *deploy         # no deployment tag
          deployment: prod    # only here

    staging:
      - step:
          <<: *build-push
          deployment: staging # only here
      - step:
          <<: *deploy         # no deployment tag
          deployment: staging # only here
